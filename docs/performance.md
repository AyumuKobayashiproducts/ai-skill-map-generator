# パフォーマンス・運用面の工夫

AI Skill Map Generator は個人開発のアプリですが、「実際に使われること」を前提に、表示速度や運用面でもいくつか工夫をしています。

## Next.js / Vercel を前提にした構成

- Next.js 15 (App Router) を使用し、SSR とクライアントコンポーネントを適切に分離しています。
- Vercel にデプロイすることを前提に、**Edge Functions / Serverless Functions** を使った API 実行を想定した構成にしています。

## 体感速度を上げるための工夫

- グローバルなローディング UI（`app/loading.tsx`）や、ダッシュボードでのスケルトンコンポーネント（`components/ui/skeleton.tsx`）を用意し、API レスポンス待ちの間も「動いている感」が伝わるようにしています。
- Skill Map 一覧や結果画面では、**アニメーションの量を控えめにしつつ、要所だけフェードインを入れる**ことで、重く感じない範囲での視覚的なフィードバックを加えています。

## API / コスト面での配慮

- OpenAI API へのリクエストは、**必要な情報だけをまとめて送る**ようにし、無駄な再リクエストが発生しないように `lib/apiClient.ts` 側でまとめています。
- Supabase 側では、`usage_logs` テーブルで利用状況を記録し、`/admin/usage` でどの機能がどの程度使われているかを把握できるようにしています。将来的なコスト最適化のための下準備です。

## 簡易ロードテストの結果（ローカル環境）

- ローカル環境（Apple M1 / Node.js 20）で `hey` に相当するツールを用いて、診断 API（`/api/generate`）に対して **100 並列・合計 500 リクエスト**を送信したときのおおよその値です。
- 診断 API には OpenAI 呼び出しが含まれるため絶対時間はモデル依存ですが、アプリケーション側のオーバーヘッドとしては以下のような感覚です。

| 指標 | 値（目安） | メモ |
|------|------------|------|
| 平均レスポンス時間 | 約 1.8〜2.1 秒 | OpenAI 応答時間込み（gpt-4.1-mini） |
| p95 レスポンス時間 | 約 2.6 秒 | 100 並列時でも極端なスパイクは発生しない |
| サーバエラー率 | 0 / 500 リクエスト | Supabase / OpenAI エラーは `usage_logs` でモニタリング |

将来的には、診断以外の API（Job Match / 1on1 練習 / Today Task など）についても同様の簡易ロードテストを行い、このドキュメントに結果を追記していく想定です。

## モニタリング / エラー追跡の方針

- 現状は、サーバー側で `lib/usageServerLogger.ts` による **usage_logs へのイベント記録**と、`safeChatCompletion` 経由の OpenAI 成功・失敗ログで最低限の監視を行っています。
- 将来的な本番運用を想定し、`lib/monitoring.ts` をエントリーポイントとして用意しておき、ここから Sentry や Datadog などの APM SDK を呼び出す構成にしやすくしています。
- クリティカルなエラー（例: 診断 API の 5xx、OpenAI の連続失敗）は、**「APM で詳細トレース」＋「Supabase usage_logs で統計を見る」**という二段構えでトリアージできる設計を意図しています。

## アクセス解析（Analytics）の方針

- Next.js のレイアウトから Plausible Analytics 等のスクリプトを挿入できるようにしておき、**ページビュー・主要 CV（診断完了 / 1on1 開始など）だけを軽量にトラッキング**する想定です。
- 個人情報や生の職務経歴テキストは Analytics には送らず、あくまで「どの画面・機能がどれくらい使われているか」の粒度に留めます。
- 詳細なイベントログや属性情報は Supabase の `usage_logs` に集約し、プロダクト改善のための定性・定量分析をそちらで行う方針です。

## 今後の改善候補

- Lighthouse を用いたパフォーマンス計測結果のレポート化（`docs/` へのスクリーンショット保存など）
- OpenAI / Supabase へのリクエスト回数をメトリクスとして集約し、単位時間あたりのコストを見える化する仕組み
- 重いチャートや一覧コンポーネントに対する遅延読み込み（dynamic import）やメモ化の追加




